<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<title>설비 비가동 관리</title>

</head>

<style>

tbody > tr {
	cursor: pointer;
	
}

</style>

<body>
	<div class="main-container">
		<div class="pd-ltr-20">
			<p style="font-size: 300%">설비 비가동 관리</p>

			<div class="card-box pd-20 mb-30">
				<div class="d-flex justify-content-between align-items-center mb-20">
					<p style="font-size: 200%">설비 비가동 목록</p>
				</div>
				<section>
					<div>
						<p style="font-size: 100%">
							<label style="font-size: 120%;">구분</label>&nbsp;&nbsp;&nbsp;&nbsp; 
							<input type="radio" id="all" name="section" value="all"> <label>전체</label>&nbsp;&nbsp;
							<input type="radio" id="operating" name="section" value="op">
							<label>가동</label>&nbsp;&nbsp; 
							<input type="radio" id="nOperating" name="section" value="nOp"> <label>비가동</label>
					</div>
				</section>

				<div style="text-align: right; margin-bottom: 10px;">

				</div>
				
				<table class="table nowrap table-hover table-striped">
					<thead>
						<tr>
							<th class="table-plus datatable-nosort">No.</th>
							<th>설비코드</th>
							<th>설비구분</th>
							<th>설비명</th>
							<th>점검주기</th>
							<th>사용여부</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="wait, sts : ${equips}">
							<tr>
								<td>[[${sts.count}]]</td>
								<td>[[${wait.eqCode}]]</td>
								<td>[[${wait.eqType}]]</td>
								<td>[[${wait.eqName}]]</td>
								<td>[[${wait.eqPeriod}]]</td>
								<td>[[${wait.use == 'Y' ? '가동' : '비가동'}]]</td>
							</tr>
						</th:block>
					</tbody>
				</table>

				<table class="table nowrap table-hover table-striped">
					<div class="d-flex justify-content-between align-items-center mb-20">
						<p style="font-size: 200%">비가동 내역</p>
						<div>
							<button type="button" class="btn btn-success">Excel</button>
							<div style="text-align: left; margin-bottom: 10px;"></div>
						</div>
					</div>
					<thead>
						<form>
							<label for="date">해당일자</label> 
							<input type="date" id="startDate" name="startDate"> ~ <input type="date" id="endDate" name="endDate">
							<div>
								<label for="eqName">설비명</label> 
								<input type="text"  placeholder=""> 
								<button>검색</button>
								<button type="reset">초기화</button>

							</div>
						</form>
						<tr>
							<th class="table-plus datatable-nosort">No.</th>
							<th>설비가동코드</th>
							<th>설비코드</th>
							<th>설비명</th>
							<th>사유</th>
							<th>시작날짜</th>
							<th>종료날짜</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="wait, sts : ${equipChck}">
							<tr>
								<td>[[${sts.count}]]</td>
								<td>[[${wait.eqChckOpcd}]]</td>
								<td>[[${wait.eqCode}]]</td>
								<td>[[${wait.eqName}]]</td>
								<td>[[${wait.reason}]]</td>
								<td>[[ ${ #dates.format(wait.startDate, "yyyy-MM-dd HH:mm" )}
									]]</td>
								<td>[[ ${ #dates.format(wait.endDate, "yyyy-MM-dd HH:mm" )} ]]</td>
							</tr>
						</th:block>
					</tbody>
				</table>
			</div>
			<!-- The Modal -->
			<div class="modal" id="nOpModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<!-- Modal Header -->
						<div class="modal-header">
							<h4 class="modal-title">비가동 설비 등록</h4>
							<button type="button" class="close" data-dismiss="modal">&times;</button>
						</div>
						<!-- Modal body -->
						<div class="modal-body">
							<form id="NeqModal" action="">
								<div class="mb-3">
									<label for="eqCode" class="form-label">설비코드 :</label> 
									<input type="text" id="eqCode" name="eqCode" value="" readonly>
								</div>
								<div class="mb-3">
									<label for="eqName" class="form-label">설비명 :</label> 
									<input type="text" id="eqName" name="eqName" value="" readonly>
								</div>
								<div class="mb-3">
									<label for="nOpTime" class="form-label">비가동 기간 :
									</label> 시작<input type="datetime-local" id="startDate" name="startDate">
											 <br />
											 종료<input type="datetime-local" id="endDate" name="endDate">
								</div>
								<div class="mb-3">
									<label for="reason" class="form-label">사유 :</label> 
									<select id="reason" name="reason">
										<option value="상시점검">상시점검
										<option value="임시점검">임시점검
										<option value="고장">고장
										<option value="부품교체">부품교체
									</select>
								</div>
								<div class="mb-3">
									<label for="use" class="form-label">사용여부</label> 
									<select name="use">
										<option value="" selected>--선택
										<option value="cannot">비가동
									</select>
								</div>
							</form>
						</div>
						<!-- Modal footer -->
						<div class="modal-footer">
							<button type="button" id="modalSubmitBtn" class="btn btn-success">등록</button>
							<button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// tr 클릭 시 이벤트 설정
			$('tbody > tr').on('click', function(event) {
				let trTag = event.currentTarget; // tr 찾기
				let eqCode = $(trTag).children().eq(1).text(); // 설비코드 가져오기
				let eqName = $(trTag).children().eq(3).text(); // 설비명 가져오기

				// 모달의 input 필드에 값 설정
				$('#eqCode').val(eqCode);
				$('#eqName').val(eqName);

				// 모달 창 표시
				$('#nOpModal').modal('show');
			});
		});
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// 라디오 버튼 클릭 시 필터링 함수
			$('input[name="section"]').on('change', function() {
				let selectedValue = $('input[name="section"]:checked').val(); // 선택된 라디오 버튼의 값 가져오기
				let rowCount = 1; // No. 재정렬을 위한 카운트 변수 초기화
				
	            // 첫 번째 테이블의 tbody에서만 필터링 적용
	            $('table:first tbody tr').each(function() {
	                let useStatus = $(this).children().eq(5).text().trim(); // '사용여부' 컬럼

					if (selectedValue === 'all') {
						// '전체' 선택 시 모든 행을 보여줌
						$(this).show();
						$(this).children().eq(0).text(rowCount++); // No. 컬럼 순차적으로 재정렬
					} else if (selectedValue === 'op') {
						// '가동' 선택 시 '가동'인 행만 보여줌
						if (useStatus === '가동') {
							$(this).show();
							$(this).children().eq(0).text(rowCount++); // No. 컬럼 순차적으로 재정렬
						} else {
							$(this).hide();
						}
					} else if (selectedValue === 'nOp') {
						// '비가동' 선택 시 '비가동'인 행만 보여줌
						if (useStatus === '비가동') {
							$(this).show();
							$(this).children().eq(0).text(rowCount++); // No. 컬럼 순차적으로 재정렬
						} else {
							$(this).hide();
						}
					}
				});
			});
		});
		
		$(document).ready(function() {
		    // 등록 버튼 클릭 시 이벤트 처리
		    $('#modalSubmitBtn').on('click', function() {
		        // 모달 창에서 입력된 데이터 가져오기
		        let eqCode = $('#eqCode').val();
		        let eqName = $('#eqName').val();
		        let startDate = $('#nOpModal #startDate').val();
		        let endDate = $('#nOpModal #endDate').val() || null;
		        let reason = $('#reason').val();
		        let use = $('#nOpModal select[name="use"]').val(); // 사용 여부 가져오기

		        // Ajax로 서버에 데이터 전송
		        $.ajax({
		            type: "POST",
		            url: "/nOpRegister",
		            contentType: "application/json",
		            data: JSON.stringify({
		                eqCode: eqCode,
		                eqName: eqName,
		                startDate: startDate,
		                endDate: endDate,
		                reason: reason,
		                use: use
		            }),
		            success: function(response) {
		                // 비가동 내역 테이블에 새로운 행 추가
		                let rowCount = $('#nOpTableBody tr').length + 1;
		                let newRow = `
		                    <tr>
		                        <td>${rowCount}</td>
		                        <td>${response.eqChckOpcd}</td>
		                        <td>${response.eqCode}</td>
		                        <td>${response.eqName}</td>
		                        <td>${response.reason}</td>
		                        <td>${response.startDate}</td>
		                        <td>${response.endDate ? response.endDate : '-'}</td>
		                        <td>${use === 'can' ? '가동' : '비가동'}</td>
		                    </tr>
		                `;
		                $('#nOpTableBody').append(newRow);
		                
		                // 첫 번째 테이블의 사용 여부 업데이트
                let updatedStatus = use === 'can' ? '가동' : '비가동';
                $('table:first tbody tr').each(function() {
                    if ($(this).children().eq(1).text().trim() === eqCode) {
                        $(this).children().eq(5).text(updatedStatus);
                    }
                });
		                // 등록 완료 알림
		                alert("등록이 완료되었습니다.");

		                // 페이지 새로고침
		                location.reload();
		                
		                // 모달 닫기 및 초기화
		                $('#nOpModal').modal('hide');
		                $('#NeqModal')[0].reset();
		            },

		            error: function(error) {
		                alert("등록 중 오류가 발생했습니다.");
		                console.error(error);
		            }
		        });
		    });
		});
	</script>
	


</body>
</html>