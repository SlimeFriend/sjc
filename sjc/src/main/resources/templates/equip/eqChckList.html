<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<title>설비 비가동 관리</title>

</head>

<style>

tbody > tr {
	cursor: pointer;
	
}

.small-input {
    width: 150px;
}

</style>

<th:block th:replace="~{common/configs/default_pageing :: pageing}"></th:block>

<body>
	<h2 class="h2 mb-20">설비 비가동 관리</h2>
				<div class="pd-30 card-box mb-20">
					<div class="d-flex justify-content-between align-items-center mb-20">
						<h4 class="h5 mb-20">설비 목록</h4>
					</div>
					<section>
						<div>
							<p style="font-size: 100%">
								<label style="font-size: 120%;">구분</label>&nbsp;&nbsp;&nbsp;&nbsp; 
								<input type="radio" id="all" name="section" value="all" checked> 
								<label>전체</label>&nbsp;&nbsp;
								<input type="radio" id="operating" name="section" value="op">
								<label>가동</label>&nbsp;&nbsp; 
								<input type="radio" id="nOperating" name="section" value="nOp"> <label>비가동</label>
						</div>
					</section>
					
					<div id="grid"></div>
				</div>
				
				<div class="card-box pd-20 mb-30">
				<!-- 두번째 페이지 -->

					<div class="d-flex justify-content-between align-items-center mb-20">
						<h4 class="h5 mb-20">비가동 내역</h4>
					</div>
					<div class="form-group row">
						<label class="col-sm-12 col-md-1 col-form-label">설비코드</label>
						<div class="col-sm-12 col-md-2">
							<input class="form-control" id="searchEqCode" type="text" placeholder="설비코드" oninput="search()" style="width: 150px;">
						</div>
					</div>
					
					<div class="form-group row">
						<label class="col-sm-12 col-md-1 col-form-label">시작일자</label>
							<div class="col-sm-12 col-md-2">
								<input class="form-control" id="startDate" type="date" oninput="search()" style="width: 150px;">
							</div>
							
							<label class="col-sm-12 col-md-1 col-form-label">이후부터</label>
					</div>
					<div class="form-group row">
							<label class="col-sm-12 col-md-1 col-form-label">종료일자</label>
							
							<div class="col-sm-12 col-md-2">
								<input class="form-control" id="endDate" type="date" oninput="search()" style="width: 150px;">
							</div>
							<label class="col-sm-12 col-md-1 col-form-label">이전까지</label>
					</div>
					
					<div id="grid2"></div>
			</div>
			<!-- The Modal -->
		    <div class="modal fade" id="nOpModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
			
				<div class="modal-dialog">
					<div class="modal-content">
						<!-- Modal Header -->
						<div class="modal-header">
							<h4 class="modal-title">비가동 설비 등록</h4>
							<button type="button" class="close" data-dismiss="modal">&times;</button>
						</div>
						<!-- Modal body -->
						<div class="modal-body">
							<form id="NeqModal" action="">
								<div class="mb-3 form-group">
									<label for="eqCode" class="form-label">설비코드 :</label> 
									<input type="text" id="eqCode" name="eqCode" value="" readonly class="form-control">
								</div>
								<div class="mb-3">
									<label for="eqName" class="form-label">설비명 :</label> 
									<input type="text" id="eqName" name="eqName" value="" readonly class="form-control">
								</div>
								<div class="mb-3">
									<label for="nOpTime" class="form-label">비가동 기간 :
									</label> 시작 <input type="datetime-local" id="modalStartDate" name="startDate" class="form-control">
											 <br />
											 종료 <input type="datetime-local" id="modalEndDate" name="endDate" class="form-control">
								</div>
								<div class="mb-3">
									<label for="reason" class="form-label">사유 :</label> 
									<select id="reason" name="reason" class="form-control">
										<option value="">선택
										<option value="상시점검">상시점검
										<option value="임시점검">임시점검
										<option value="고장">고장
										<option value="부품교체">부품교체
									</select>
								</div>
								<div class="mb-3">
									<label for="use" class="form-label">사용여부</label> 
									<select name="use" id="use" class="form-control">
										<option value="" selected>선택
										<option id="use" value="Y">가동
										<option id="use" value="N">비가동
									</select>
								</div>
							</form>
						</div>
						<!-- Modal footer -->
						<div class="modal-footer">
							<button type="button" id="modalSubmitBtn" class="btn btn-success">등록</button>
							<button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>
		
	

<script th:inline="javascript">
    $(document).ready(function() {
        
        const gridData = /*[[${equips}]]*/[];
        const gridData2 = /*[[${equipChck}]]*/[];
        
        const grid = new tui.Grid({
            el : document.getElementById('grid'),
            data : gridData,
            scrollX : false,
            scrollY : false,
            columns : [ 
                {
                    header : '설비코드',
                    name : 'eqCode',
                    align : 'center',
                }, 
                {
                    header : '설비구분',
                    name : 'eqType',
                    align : 'center',
                },
                {
                    header : '설비명',
                    name : 'eqName',
                    align : 'center',
                }, 
                {
                    header : '점검주기',
                    name : 'eqPeriod',
                    align : 'center',
                }, 
                {
                    header : '가동상태',
                    name : 'use',
                    align : 'center',
                    formatter: function(item) {
                        return item.value === 'Y' 
                        ? '<span style="color: blue;">가동</span>'
                        : '<span style="color: red;">비가동</span>';
                    }
                }, 
            ],
            rowHeaders : [ 'rowNum' ],
            pageOptions: {
                useClient : true,
                perPage : 5
            }, 
        });
        
        const grid2 = new tui.Grid({
            el : document.getElementById('grid2'),
            data : gridData2,
            scrollX : false,
            scrollY : false,
            columns : [ 
                {
                    header : '설비가동코드',
                    name : 'eqChckOpcd',
                    align : 'center',
                }, 
                {
                    header : '설비코드',
                    name : 'eqCode',
                    align : 'center',
                },
                {
                    header : '설비명',
                    name : 'eqName',
                    align : 'center',
                }, 
                {
                    header : '사유',
                    name : 'reason',
                    align : 'center',
                }, 
                {
                    header : '점검유무',
                    name : 'eqChckOx',
                    align : 'center',
                }, 
                {
                    header : '시작날짜',
                    name : 'startDate',
                    align : 'center',
                },
                {
                    header : '종료날짜',
                    name : 'endDate',
                    align : 'center',
                },
            ],
            rowHeaders : [ 'rowNum' ],
            pageOptions: {
                useClient : true,
                perPage : 5
            }, 
        });
        
        // 라디오 버튼에 따른 필터링
        $('input[name="section"]').on('change', function() {
            const selectedValue = $('input[name="section"]:checked').val();

            let filteredData;
            if (selectedValue === 'all') {
                filteredData = gridData;
            } else if (selectedValue === 'op') {
                filteredData = gridData.filter(row => row.use === 'Y');
            } else if (selectedValue === 'nOp') {
                filteredData = gridData.filter(row => row.use === 'N');
            }

            // 필터링된 데이터로 그리드 데이터 초기화
            grid.resetData(filteredData);
        });
        
        // 기타 이벤트 코드 유지
        grid.on('click', (event) => {
            const rowKey = event.rowKey;
            const rowData = grid.getRow(rowKey);
            const eqCode = rowData.eqCode;
            const eqName = rowData.eqName;

            const payload = { eqCode: eqCode };

            $.ajax({
                url: 'getEqChckOx',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    if (response) {
                        alert("이미 비가동 내역에 등록 되어 있습니다.");
                    } else {
                        $('#eqCode').val(eqCode);
                        $('#eqName').val(eqName);
                        $('#nOpModal').data('selectedRowKey', rowKey); // 행 키를 저장
                        $('#nOpModal').modal('show');
                    }
                },
                error: function(error) {
                    console.error("Error fetching data:", error);
                }
            });
        });

        // 모달창에서 '등록' 버튼 클릭 시 이벤트
        $('#modalSubmitBtn').on('click', function() {
            const eqCode = $('#eqCode').val();
            const eqName = $('#eqName').val();
            const useValue = $('#use').val();
            const selectedRowKey = $('#nOpModal').data('selectedRowKey');

            if (useValue === 'Y') {
                $.ajax({
                    type: "POST",
                    url: "/updateUseStatus",
                    contentType: "application/json",
                    data: JSON.stringify({ eqCode: eqCode, use: useValue }),
                    success: function(response) {
                        if (response.result) {
                            grid.setValue(selectedRowKey, 'use', '가동');
                            alert("설비가 '가동' 상태로 업데이트되었습니다.");
                        } else {
                            alert("업데이트에 실패했습니다.");
                        }
                        $('#nOpModal').modal('hide');
                    },
                    error: function(error) {
                        alert("업데이트 중 오류가 발생했습니다.");
                        console.error(error);
                    }
                });
                return;
            }

            // 비가동일 경우만 Ajax를 통해 서버에 전송
            const startDate = $('#modalStartDate').val();
            const endDate = $('#modalEndDate').val();
            const reason = $('#reason').val();

            $.ajax({
                type: "POST",
                url: "/nOpRegister",
                contentType: "application/json",
                data: JSON.stringify({
                    eqCode: eqCode,
                    eqName: eqName,
                    startDate: startDate,
                    endDate: endDate,
                    reason: reason,
                    use: useValue
                }),
                success: function(response) {
                    grid.setValue(selectedRowKey, 'use', '비가동');
                    alert("비가동 상태로 등록되었습니다.");
                    $('#nOpModal').modal('hide');
                    location.reload();
                },
                error: function(error) {
                    alert("등록 중 오류가 발생했습니다.");
                    console.error(error);
                }
            });
        });
    });
</script>


</body>
</html>