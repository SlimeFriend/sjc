<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<title>설비 비가동 관리</title>
</head>

<body>
    <div class="main-container">
        <div class="pd-ltr-20">
            <p style="font-size: 300%">설비 비가동 관리</p>

            <!-- 첫 번째 Grid: 설비 비가동 목록 -->
            <div class="card-box pd-20 mb-30">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p style="font-size: 200%">설비 비가동 목록</p>

                    <!-- 구분 필터 -->
                    <section>
                        <label style="font-size: 120%;">구분:</label>
                        <input type="radio" id="all" name="section" value="all" checked> 전체
                        <input type="radio" id="operating" name="section" value="op"> 가동
                        <input type="radio" id="nOperating" name="section" value="nOp"> 비가동
                    </section>
                </div>

                <div id="grid1"></div>
            </div>

            <!-- 두 번째 Grid: 비가동 내역 -->
            <div class="card-box pd-20 mb-30">
                <p style="font-size: 200%">비가동 내역</p>

                <!-- 비가동 내역 검색 필터 -->
                <div class="form-group row mt-3">
                    <label class="col-sm-12 col-md-1 col-form-label">설비코드</label>
                    <div class="col-sm-12 col-md-2">
                        <input class="form-control" id="searchEqCode" type="text" placeholder="설비코드">
                    </div>
                    <label class="col-sm-12 col-md-1 col-form-label">시작일자</label>
                    <div class="col-sm-12 col-md-2">
                        <input class="form-control" id="startDate" type="date">
                    </div>
                    <label class="col-sm-12 col-md-1 col-form-label">종료일자</label>
                    <div class="col-sm-12 col-md-2">
                        <input class="form-control" id="endDate" type="date">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="search()">검색</button>
                </div>

                <div id="grid2"></div>
            </div>

            <!-- 비가동 등록 모달 -->
            <div class="modal fade" id="nOpModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">비가동 설비 등록</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="NeqModal">
                                <div class="mb-3">
                                    <label for="eqCode" class="form-label">설비코드 :</label>
                                    <input type="text" id="eqCode" name="eqCode" readonly class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="eqName" class="form-label">설비명 :</label>
                                    <input type="text" id="eqName" name="eqName" readonly class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="nOpTime" class="form-label">비가동 기간 :</label>
                                    시작 <input type="datetime-local" id="modalStartDate" name="startDate" class="form-control">
                                    <br /> 종료 <input type="datetime-local" id="modalEndDate" name="endDate" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="reason" class="form-label">사유 :</label>
                                    <select id="reason" name="reason" class="form-control">
                                        <option value="">선택</option>
                                        <option value="상시점검">상시점검</option>
                                        <option value="임시점검">임시점검</option>
                                        <option value="고장">고장</option>
                                        <option value="부품교체">부품교체</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="use" class="form-label">사용여부</label>
                                    <select name="use" id="use" class="form-control">
                                        <option value="" selected>선택</option>
                                        <option value="Y">가동</option>
                                        <option value="N">비가동</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="modalSubmitBtn" class="btn btn-success">등록</button>
                            <button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script th:inline="javascript">
    // Toast Grid 설정 - 첫 번째 Grid: 설비 비가동 목록
    const gridData1 = /*[[${equips}]]*/[];
    const grid1 = new tui.Grid({
        el: document.getElementById('grid1'),
        data: gridData1,
        columns: [
            { header: 'No.', name: 'count', width: 50, align: 'center' },
            { header: '설비코드', name: 'eqCode', align: 'center' },
            { header: '설비구분', name: 'eqType', align: 'center' },
            { header: '설비명', name: 'eqName', align: 'center' },
            { header: '점검주기', name: 'eqPeriod', align: 'center' },
            { header: '가동상태', name: 'use', align: 'center',
              formatter: function(item) {
                return item.value === 'Y' ? '<span style="color: blue;">가동</span>' : '<span style="color: red;">비가동</span>';
              }
            },
        ],
        rowHeaders: ['checkbox'],
        pageOptions: {
            useClient: true,
            perPage: 4
        },
    });

    // 행 클릭 시 비가동 모달 열기
    grid1.on('click', ev => {
        const rowData = grid1.getRow(ev.rowKey);
        $('#eqCode').val(rowData.eqCode);
        $('#eqName').val(rowData.eqName);
        $('#nOpModal').modal('show');
    });

    // Toast Grid 설정 - 두 번째 Grid: 비가동 내역
    const gridData2 = /*[[${equipChck}]]*/[];
    const grid2 = new tui.Grid({
        el: document.getElementById('grid2'),
        data: gridData2,
        columns: [
            { header: 'No.', name: 'count', width: 50, align: 'center' },
            { header: '설비가동코드', name: 'eqChckOpcd', align: 'center' },
            { header: '설비코드', name: 'eqCode', align: 'center' },
            { header: '설비명', name: 'eqName', align: 'center' },
            { header: '사유', name: 'reason', align: 'center' },
            { header: '점검유무', name: 'eqChckOx', align: 'center' },
            { header: '시작날짜', name: 'startDate', align: 'center' },
            { header: '종료날짜', name: 'endDate', align: 'center' },
        ],
        pageOptions: {
            useClient: true,
            perPage: 4
        },
    });

    // 구분 필터링
    $('input[name="section"]').on('change', function() {
        const selectedValue = $('input[name="section"]:checked').val();

        grid1.filter(row => {
            const useStatus = row.use === 'Y' ? '가동' : '비가동';
            return selectedValue === 'all' || (selectedValue === 'op' && useStatus === '가동') || (selectedValue === 'nOp' && useStatus === '비가동');
        });
    });

    // 검색 기능
    function search() {
        const eqCode = $('#searchEqCode').val();
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        $.ajax({
            url: '/eqSearch',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ eqCode, startDate, endDate }),
            success: function(response) {
                grid2.resetData(response);
            },
            error: function() {
                alert('검색 중 오류가 발생했습니다.');
            }
        });
    }

    // 비가동 등록 버튼 클릭 시
    $('#modalSubmitBtn').on('click', function() {
        const eqData = {
            eqCode: $('#eqCode').val(),
            eqName: $('#eqName').val(),
            startDate: $('#modalStartDate').val(),
            endDate: $('#modalEndDate').val(),
            reason: $('#reason').val(),
            use: $('#use').val()
        };

        if (eqData.use === 'Y') {
            alert("가동으로 설정되었습니다.");
            $('#nOpModal').modal('hide');
            return;
        }

        $.ajax({
            type: "POST",
            url: "/nOpRegister",
            contentType: "application/json",
            data: JSON.stringify(eqData),
            success: function() {
                alert("비가동이 등록되었습니다.");
                location.reload();
            },
            error: function() {
                alert("등록 중 오류가 발생했습니다.");
            }
        });
    });
</script>
</body>
</html>
