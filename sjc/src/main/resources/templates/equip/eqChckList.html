<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<title>설비 비가동 관리</title>

</head>

<style>

tbody > tr {
	cursor: pointer;
	
}

</style>

<body>
	<div class="main-container">
		<div class="pd-ltr-20">
			<p style="font-size: 300%">설비 비가동 관리</p>

			<div class="card-box pd-20 mb-30">
				<div class="d-flex justify-content-between align-items-center mb-20">
					<p style="font-size: 200%">설비 비가동 목록</p>
				</div>
				<section>
					<div>
						<p style="font-size: 100%">
							<label style="font-size: 120%;">구분</label>&nbsp;&nbsp;&nbsp;&nbsp; 
							<input type="radio" id="all" name="section" value="all" checked> 
							<label>전체</label>&nbsp;&nbsp;
							<input type="radio" id="operating" name="section" value="op">
							<label>가동</label>&nbsp;&nbsp; 
							<input type="radio" id="nOperating" name="section" value="nOp"> <label>비가동</label>
					</div>
				</section>

				<div style="text-align: right; margin-bottom: 10px;">

				</div>
				
				<table class="table nowrap table-hover table-striped">
					<thead>
						<tr>
							<th class="table-plus datatable-nosort">No.</th>
							<th>설비코드</th>
							<th>설비구분</th>
							<th>설비명</th>
							<th>점검주기</th>
							<th>사용여부</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="wait, sts : ${equips}">
							<tr>
								<td>[[${sts.count}]]</td>
								<td>[[${wait.eqCode}]]</td>
								<td>[[${wait.eqType}]]</td>
								<td>[[${wait.eqName}]]</td>
								<td>[[${wait.eqPeriod}]]</td>
								<td>[[${wait.use == 'Y' ? '가동' : '비가동'}]]</td>
							</tr>
						</th:block>
					</tbody>
				</table>

				<table class="table nowrap table-hover table-striped">
					<div class="d-flex justify-content-between align-items-center mb-20">
						<p style="font-size: 200%">비가동 내역</p>
					</div>
					<thead>
						<form id="searchForm">
							<label for="date">해당일자</label> 
							<input type="date" id="startDate" name="startDate"> ~ 
							<input type="date" id="endDate" name="endDate">
							<div>
								<label for="eqCode">설비코드 :</label> 
								<input type="text" id="SearchEqCode" placeholder="설비코드"> 
								<button type="button" id="searchBtn">검색</button>
								<button type="reset">초기화</button>
							</div>
						</form>
						<tr>
							<th class="table-plus datatable-nosort">No.</th>
							<th>설비가동코드</th>
							<th>설비코드</th>
							<th>설비명</th>
							<th>사유</th>
							<th>점검유무</th>
							<th>시작날짜</th>
							<th>종료날짜</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="wait, sts : ${equipChck}">
							<tr>
								<td>[[${sts.count}]]</td>
								<td>[[${wait.eqChckOpcd}]]</td>
								<td>[[${wait.eqCode}]]</td>
								<td>[[${wait.eqName}]]</td>
								<td>[[${wait.reason}]]</td>
								<td>[[${wait.eqChckOx}]]</td>
								<td>[[ ${ #dates.format(wait.startDate, "yyyy-MM-dd HH:mm" )}
									]]</td>
								<td>[[ ${ #dates.format(wait.endDate, "yyyy-MM-dd HH:mm" )} ]]</td>
							</tr>
						</th:block>
					</tbody>
				</table>
			</div>
			<!-- The Modal -->
		    <div class="modal fade" id="nOpModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
			
				<div class="modal-dialog">
					<div class="modal-content">
						<!-- Modal Header -->
						<div class="modal-header">
							<h4 class="modal-title">비가동 설비 등록</h4>
							<button type="button" class="close" data-dismiss="modal">&times;</button>
						</div>
						<!-- Modal body -->
						<div class="modal-body">
							<form id="NeqModal" action="">
								<div class="mb-3 form-group">
									<label for="eqCode" class="form-label">설비코드 :</label> 
									<input type="text" id="eqCode" name="eqCode" value="" readonly class="form-control">
								</div>
								<div class="mb-3">
									<label for="eqName" class="form-label">설비명 :</label> 
									<input type="text" id="eqName" name="eqName" value="" readonly class="form-control">
								</div>
								<div class="mb-3">
									<label for="nOpTime" class="form-label">비가동 기간 :
									</label> 시작 <input type="datetime-local" id="modalStartDate" name="startDate" class="form-control">
											 <br />
											 종료 <input type="datetime-local" id="modalEndDate" name="endDate" class="form-control">
								</div>
								<div class="mb-3">
									<label for="reason" class="form-label">사유 :</label> 
									<select id="reason" name="reason" class="form-control">
										<option value="">선택
										<option value="상시점검">상시점검
										<option value="임시점검">임시점검
										<option value="고장">고장
										<option value="부품교체">부품교체
									</select>
								</div>
								<div class="mb-3">
									<label for="use" class="form-label">사용여부</label> 
									<select name="use" id="use" class="form-control">
										<option value="" selected>선택
										<option id="use" value="Y">가동
										<option id="use" value="N">비가동
									</select>
								</div>
							</form>
						</div>
						<!-- Modal footer -->
						<div class="modal-footer">
							<button type="button" id="modalSubmitBtn" class="btn btn-success">등록</button>
							<button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

<script>
    $(document).ready(function() {
        // 테이블 행 클릭 시 이벤트 설정
        $('tbody > tr').on('click', function(event) {
            let trTag = event.currentTarget;
            let eqCode = $(trTag).children().eq(1).text(); // 설비코드 가져오기
            let eqName = $(trTag).children().eq(3).text(); // 설비명 가져오기
            
            const payload ={
            		eqCode : eqCode
            }
            
       	    $.ajax({
       	        url: 'getEqChckOx',
       	        type: 'POST',
       	        contentType: 'application/json',
       	        data: JSON.stringify(payload),
       	        success: function(response) {
       	        	if(response){
       	        		alert("이미 비가동 등록 되어 있습니다.")
       	        	}
       	        	else{
			            // 모달의 input 필드에 값 설정
			            $('#eqCode').val(eqCode);
			            $('#eqName').val(eqName);
			
			            // 선택된 행을 모달에 저장 (등록 시 업데이트 용도)
			            $('#nOpModal').data('selectedRow', $(this));
			
			            // 모달 창 표시
			            $('#nOpModal').modal('show');
       	        		
       	        	}
       	            //console.log(response);
       	            return false;
       	        }
       	    });	
        });

        // 사용 여부가 '가동'일 때 비가동 기간 및 사유 필드 비활성화
        $('select[name="use"]').on('change', function() {
            const useValue = $(this).val();
            if (useValue === 'Y') {
                $('#modalStartDate, #modalEndDate, #reason').prop('disabled', true);
                $('#modalStartDate, #modalEndDate').val('');
                $('#reason').val('');
            } else {
                $('#modalStartDate, #modalEndDate, #reason').prop('disabled', false);
            }
        });

        // 모달창에서 '등록' 버튼 클릭 시 이벤트
        $('#modalSubmitBtn').on('click', function() {
            const eqCode = $('#eqCode').val();
            const eqName = $('#eqName').val();
            const useValue = $('#use').val();
            const selectedRow = $('#nOpModal').data('selectedRow');

            if (useValue === 'Y') {
                // 첫 번째 테이블의 사용 여부를 '가동'으로 업데이트
                selectedRow.find('td').eq(5).text('가동');
                alert("설비가 '가동' 상태로 업데이트되었습니다.");
                $('#nOpModal').modal('hide');
                $('#NeqModal')[0].reset();
                return; // '가동'일 때는 서버 전송 없이 종료
            } 

            // 비가동일 경우만 Ajax를 통해 서버에 전송
            const startDate = $('#modalStartDate').val();
            const endDate = $('#modalEndDate').val();
            const reason = $('#reason').val();

            $.ajax({
                type: "POST",
                url: "/nOpRegister",
                contentType: "application/json",
                data: JSON.stringify({
                    eqCode: eqCode,
                    eqName: eqName,
                    startDate: startDate,
                    endDate: endDate,
                    reason: reason,
                    use: useValue
                }),
                success: function(response) {
                    // 비가동 내역 테이블에 새로운 행 추가
                    let rowCount = $('#nOpTableBody tr').length + 1;
                    let newRow = `
                        <tr>
                            <td>${rowCount}</td>
                            <td>${response.eqChckOpcd}</td>
                            <td>${response.eqCode}</td>
                            <td>${response.eqName}</td>
                            <td>${response.reason || '-'}</td>
                            <td>${response.startDate || '-'}</td>
                            <td>${response.endDate || '-'}</td>
                            <td>${useValue === 'Y' ? '가동' : '비가동'}</td>
                        </tr>
                    `;
                    $('#nOpTableBody').append(newRow);

                    // 첫 번째 테이블의 사용 여부 업데이트
                    selectedRow.find('td').eq(5).text(useValue === 'Y' ? '가동' : '비가동');

                    // 등록 완료 알림
                    alert("등록이 완료되었습니다.");
                    location.reload(); // 페이지 새로고침
                    $('#nOpModal').modal('hide');
                    $('#NeqModal')[0].reset();
                },
                error: function(error) {
                    alert("등록 중 오류가 발생했습니다.");
                    console.error(error);
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        // 라디오 버튼에 따른 필터링
        $('input[name="section"]').on('change', function() {
            const selectedValue = $('input[name="section"]:checked').val();

            $('table:first tbody tr').each(function() {
                const useStatus = $(this).find('td').eq(5).text();

                if (selectedValue === 'all') {
                    // 전체 보기
                    $(this).show();
                } else if (selectedValue === 'op' && useStatus === '가동') {
                    // 가동만 보기
                    $(this).show();
                } else if (selectedValue === 'nOp' && useStatus === '비가동') {
                    // 비가동만 보기
                    $(this).show();
                } else {
                    // 조건에 맞지 않는 행 숨기기
                    $(this).hide();
                }
            });
        });
    });
</script>
<script>
//모달창에서 '등록' 버튼 클릭 시 이벤트
$('#modalSubmitBtn').on('click', function() {
    const eqCode = $('#eqCode').val();
    const useValue = $('#use').val();
    const selectedRow = $('#nOpModal').data('selectedRow');

    if (useValue === 'Y') {
        // 사용여부가 '가동'일 경우만 서버로 업데이트 요청
        $.ajax({
            type: "POST",
            url: "/updateUseStatus",
            contentType: "application/json",
            data: JSON.stringify({
                eqCode: eqCode,
                use: useValue
            }),
            success: function(response) {
                if (response.result) {
                    // 첫 번째 테이블의 사용 여부 업데이트
                    selectedRow.find('td').eq(5).text('가동');
                    alert("설비가 '가동' 상태로 업데이트되었습니다.");
                    location.reload(); // 페이지 새로고침
                } else {
                    alert("업데이트에 실패했습니다.");
                }
                $('#nOpModal').modal('hide');
            },
            error: function(error) {
                alert("업데이트 중 오류가 발생했습니다.");
                console.error(error);
            }
        });
    }
});

</script>
	


</body>
</html>