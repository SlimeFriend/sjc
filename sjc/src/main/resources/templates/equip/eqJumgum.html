<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">

<title>설비 점검 목록</title>
</head>

<style>

tbody > tr {
	cursor: pointer;
	
}

</style>
<th:block th:replace="~{common/configs/default_pageing :: pageing}"></th:block>
<body>
	<h2 class="h2 mb-20">설비 점검</h2>
		<div class="pd-30 card-box mb-20">
			<div class="d-flex justify-content-between align-items-center mb-20">
				<h4 class="h5 mb-20">설비 점검 목록</h4>
				<div>
					<button type="button" class="btn btn-success">점검완료</button>
				</div>
			</div>
			<!-- 버튼을 우측 상단으로 이동 -->
			<div style="text-align: right; margin-bottom: 10px;"></div>
			<!-- 
			<table class="data-table table nowrap">
			 -->
			
			<div id="grid"></div>

			<table class="table nowrap table-hover table-striped">
				<thead>
					<tr>
						<th></th>
						<th class="table-plus datatable-nosort">No.</th>
						<th>설비코드</th>
						<th>점검주기</th>
						<th>점검일자</th>
						<th>다음점검일</th>
						<th>점검유무</th>
					</tr>
				</thead>
				<tbody>
					<th:block th:each="wait, sts : ${equipjg}">
						<tr>
							<td><div class="form-check form-check-inline">
									<input class="form-check-input" type="checkbox" id="eqchck" value="option1"> 
									<label class="form-check-label" for="eqchck"></label>
								</div></td>
							<td>[[${sts.count}]]</td>
							<td>[[${wait.eqCode}]]</td>
							<td>[[${wait.eqPeriod}]] 개월</td>
							<td>[[ ${ #dates.format(wait.eqCkDate, "yyyy년 MM월 dd일" )}
								]]</td>
							<td>[[ ${ #dates.format(wait.eqNextChck, "yyyy년 MM월 dd일" )}
								]]</td>
							<td>[[${wait.eqChckOx}]]</td>
						</tr>
					</th:block>
				</tbody>
			</table>
		</div>
	
	<script th:inline="javascript">
    $(document).ready(function() {
        const gridData = /*[[${equipjg}]]*/[];

        // 날짜 포맷팅 함수 추가
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Toast UI Grid 초기화
        const grid = new tui.Grid({
            el: document.getElementById('grid'),
            data: gridData,
            scrollX: false,
            scrollY: false,
            columns: [
                {
                    header: '설비코드',
                    name: 'eqCode',
                    align: 'center',
                },
                {
                    header: '점검주기',
                    name: 'eqPeriod',
                    align: 'center',
                },
                {
                    header: '점검일자',
                    name: 'eqCkDate',
                    align: 'center',
                    formatter: function(item) {
                        return formatDate(item.value); // 날짜 포맷 적용
                    }
                },
                {
                    header: '다음점검일',
                    name: 'eqNextChck',
                    align: 'center',
                    formatter: function(item) {
                        return formatDate(item.value); // 날짜 포맷 적용
                    }
                },
                {
                    header: '점검유무',
                    name: 'eqChckOx',
                    align: 'center',
                },
            ],
            rowHeaders: ['checkbox'],
            pageOptions: {
                useClient: true,
                perPage: 5,
            },
        });

        // '점검완료' 버튼 클릭 이벤트
        $('.btn-success').on('click', function () {
            const today = new Date();
            const nextCheckDate = new Date();
            nextCheckDate.setMonth(today.getMonth() + 3); // 3개월 후

            const formattedToday = formatDate(today); // 날짜 포맷 적용
            const formattedNextCheckDate = formatDate(nextCheckDate); // 날짜 포맷 적용

            // 선택된 체크박스의 행을 가져오기
            const checkedRows = grid.getCheckedRows();

            if (checkedRows.length === 0) {
                alert("점검할 설비를 선택하세요.");
                return;
            }

            checkedRows.forEach(row => {
                const eqCode = row.eqCode;
                const checkStatus = row.eqChckOx;

                // 점검유무가 "점검완료"인 경우 알림 표시 및 종료
                if (checkStatus === "점검완료") {
                    alert("이미 점검이 완료된 설비입니다.");
                    return;
                }

                // 그리드 데이터 업데이트
                grid.setValue(row.rowKey, 'eqCkDate', formattedToday);
                grid.setValue(row.rowKey, 'eqNextChck', formattedNextCheckDate);
                grid.setValue(row.rowKey, 'eqChckOx', "점검완료");

                // AJAX로 서버에 데이터 전송하여 DB 업데이트
                $.ajax({
                    type: "POST",
                    url: "/updateCheckStatus",
                    contentType: "application/json",
                    data: JSON.stringify({
                        eqCode: eqCode,
                        eqCkDate: formattedToday,
                        eqNextChck: formattedNextCheckDate,
                        eqChckOx: "점검완료"
                    }),
                    success: function () {
                        alert("점검이 완료되었습니다.");
                        window.location.href = "/eqChckList"; // 페이지 새로고침
                    },
                    error: function (error) {
                        alert("점검 완료 처리 중 오류가 발생했습니다.");
                        console.error(error);
                    }
                });
            });
        });
    });
</script>



</body>
</html>