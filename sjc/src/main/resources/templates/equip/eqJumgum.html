<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">

<title>설비 점검 목록</title>
</head>

<style>

tbody > tr {
	cursor: pointer;
	
}

</style>

<body>
	<div class="main-container">
		<div class="pd-ltr-20">
		<p style="font-size: 300%">설비 점검</p>
			<div class="card-box pd-20 mb-30">
				<div class="d-flex justify-content-between align-items-center mb-20">
					<p style="font-size: 200%">설비 점검 목록</p>
					<div>
						<button type="button" class="btn btn-success">점검완료</button>
					</div>
				</div>
				<!-- 버튼을 우측 상단으로 이동 -->
				<div style="text-align: right; margin-bottom: 10px;"></div>
				<!-- 
				<table class="data-table table nowrap">
				 -->

				<table class="table nowrap table-hover table-striped">
					<thead>
						<tr>
							<th></th>
							<th class="table-plus datatable-nosort">No.</th>
							<th>설비코드</th>
							<th>점검주기</th>
							<th>점검일자</th>
							<th>다음점검일</th>
							<th>점검유무</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="wait, sts : ${equipjg}">
							<tr>
								<td><div class="form-check form-check-inline">
										<input class="form-check-input" type="checkbox" id="eqchck" value="option1"> 
										<label class="form-check-label" for="eqchck"></label>
									</div></td>
								<td>[[${sts.count}]]</td>
								<td>[[${wait.eqCode}]]</td>
								<td>[[${wait.eqPeriod}]]</td>
								<td>[[ ${ #dates.format(wait.eqCkDate, "yyyy년 MM월 dd일" )}
									]]</td>
								<td>[[ ${ #dates.format(wait.eqNextChck, "yyyy년 MM월 dd일" )}
									]]</td>
								<td>[[${wait.eqChckOx}]]</td>
							</tr>
						</th:block>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// tr 클릭 시 이벤트 설정
			$('tbody > tr').on('click', function(event) {
				// 체크박스 찾기
				let checkbox = $(this).find('input[type="checkbox"]');
				// 체크 여부 토글
				checkbox.prop('checked', !checkbox.prop('checked'));
				// 이벤트가 체크박스 자체 클릭에서 발생한 경우 전파 방지
				event.stopPropagation();
			});

			// 체크박스 클릭 시 이벤트 전파 방지
			$('input[type="checkbox"]').on('click', function(event) {
				event.stopPropagation();
			});
		});
	</script>
<script>
    $(document).ready(function () {
        // 점검완료 버튼 클릭 시
        $('.btn-success').on('click', function () {
            let today = new Date();
            let nextCheckDate = new Date();
            nextCheckDate.setMonth(today.getMonth() + 3);  // 3개월 후

            let formattedToday = today.toISOString().split('T')[0];  // yyyy-mm-dd
            let formattedNextCheckDate = nextCheckDate.toISOString().split('T')[0];  // 3개월 후 날짜

            // 선택된 체크박스의 부모 행을 찾고 데이터를 업데이트
            $('input[type="checkbox"]:checked').each(function () {
                let row = $(this).closest('tr');
                let eqCode = row.find('td').eq(2).text().trim(); // 설비코드

                row.find('td').eq(4).text(formattedToday);  // 점검일자
                row.find('td').eq(5).text(formattedNextCheckDate);  // 다음 점검일
                row.find('td').eq(6).text("점검완료");  // 점검유무

                // AJAX로 서버에 데이터 전송하여 DB 업데이트
                $.ajax({
                    type: "POST",
                    url: "/updateCheckStatus",
                    contentType: "application/json",
                    data: JSON.stringify({
                        eqCode: eqCode,
                        eqCkDate: formattedToday,
                        eqNextChck: formattedNextCheckDate,
                        eqChckOx: "점검완료"
                    }),
                    success: function (response) {
                        alert("점검이 완료되었습니다.");
                        // equipInfo.html로 이동하여 최신 점검일자 확인
                        window.location.href = "/eqInfo?eqCode=" + eqCode;
                    },
                    error: function (error) {
                        alert("점검 완료 처리 중 오류가 발생했습니다.");
                        console.error(error);
                    }
                });
            });
        });
    });
</script>


</body>
</html>