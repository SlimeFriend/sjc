<div xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
	
	<head>
    	<title>주문내역</title>
    	<style>
	    	#gridOrder:hover {
	    		cursor: pointer;
	    	}
    	</style>
	</head>

	<!-- 페이징 필요하신분 -->
	<th:block th:replace="~{common/configs/default_pageing :: pageing}"></th:block>
	<div class="main-container">
		<div class="pd-30">
			<h2 class="h2 mb-20">주문내역</h2>
			<div class="pd-30 card-box mb-20">
				<form>
					<div class="form-group row" style="display: flex; align-items: center; flex-wrap: wrap;">
					    <label class="col-sm-12 col-md-1 col-form-label">진행상황</label>
					
					    <div class="col-sm-12 col-md-3 d-flex" style="flex-wrap: wrap;">
					        <div style="margin-right: 30px; display: flex; align-items: center;">
					            <input type="radio" id="option1" name="option" value="" style="margin-right: 8px;" checked="checked">
					            <label for="option1" style="margin-bottom: 0px;">전체</label>
					        </div>
					        
					        <div style="margin-right: 30px; display: flex; align-items: center;">
					            <input type="radio" id="option2" name="option" value="주문접수" style="margin-right: 8px;">
					            <label for="option2" style="margin-bottom: 0px;">주문접수</label>
					        </div>
					        
					        <div style="margin-right: 30px; display: flex; align-items: center;">
					            <input type="radio" id="option3" name="option" value="출고완료" style="margin-right: 8px;">
					            <label for="option3" style="margin-bottom: 0px;">출고완료</label>
					        </div>	        
					    </div>
					</div>

					
					<div class="form-group row">
						<label class="col-sm-12 col-md-1 col-form-label">업체명</label>
						<div class="col-sm-12 col-md-3">
							<input class="form-control" id="companyName" type="text" placeholder="업체명" oninput="performSearch()">
						</div>
					</div>

					<div class="form-group row">
						<label class="col-sm-12 col-md-1 col-form-label">주문일자</label>
						<div class="col-sm-12 col-md-3">
							<input class="form-control" id="orderStartDate" type="date" oninput="performSearch()">
						</div>
						<div
							class="col-sm-12 col-md-auto d-flex align-items-center justify-content-center">
							<span style="font-size: 1rem;">~</span>
						</div>
						<div class="col-sm-12 col-md-3">
							<input class="form-control" id="orderEndDate" type="date" oninput="performSearch()">
						</div>
					</div>

					<div class="form-group row">
						<label class="col-sm-12 col-md-1 col-form-label">납기일자</label>
						<div class="col-sm-12 col-md-3">
							<input class="form-control" id="deliveryStartDate" type="date" oninput="performSearch()">
						</div>
						<div
							class="col-sm-12 col-md-auto d-flex align-items-center justify-content-center">
							<span style="font-size: 1rem;">~</span>
						</div>
						<div class="col-sm-12 col-md-3">
							<input class="form-control" id="deliveryEndDate" type="date" oninput="performSearch()">
						</div>
					</div>
				</form>
			</div>
			<div id="gridOrder" class="mb-20"></div>
			<div id="gridOrderDetail" style="display : none"></div>
		</div>
	</div>

	<script th:inline="javascript">
		let grid;
		
		document.addEventListener('DOMContentLoaded', function() {
			
			const gridData = /*[[${ord}]]*/[];
			const gridModalData = /*[[${ordDetail}]]*/[];

			grid = new tui.Grid({
				el : document.getElementById('gridOrder'),
				data : gridData,
				scrollX : false,
				scrollY : true,
				columns : [ {
					header : '주문코드',
					name : 'ordCode',
					align : 'center',
				}, {
					header : '업체명',
					name : 'cpName',
					align : 'center',
				}, {
					header : '주문일자',
					name : 'ordDate',
					align : 'center',
				}, {
					header : '납기일자',
					name : 'dlvReqDate',
					align : 'center',
				}, {
					header : '진행상황',
					name : 'ordStatus',
					align : 'center',
				}, {
					header : '요청사항',
					name : 'comm',
					align : 'center',
				}, ],
				rowHeaders : [ 'rowNum' ],
				bodyHeight: 280,
				pageOptions: {
				    type: 'scroll',
				    perPage: 10 
				},
			});
			
			const gridModal = new tui.Grid({
				el : document.getElementById('gridOrderDetail'),
				data : gridModalData,
				scrollX : false,
				scrollY : false,
				columns : [ {
					header : '주문코드',
					name : 'ORDCODE',
					align : 'center',
				}, {
					header : '제품명',
					name : 'PRDNAME',
					align : 'center',
				}, {
					header : '제품코드',
					name : 'PRDCODE',
					align : 'center',
				}, {
					header : '주문량',
					name : 'ORDQUANTITY',
					align : 'center',
				}, {
					header : '부족량',
					name : 'LACKQUANTITY',
					align : 'center',
				},],
				rowHeaders : [ 'rowNum' ],
				pageOptions : {
					useClient : true,
					perPage : 5
				}
			});
			
			grid.getData().forEach(row => {
			    if (row.ordStatus === '재고부족') {
			    	grid.addCellClassName(row.rowKey, 'ordStatus', 'bg-light-pink'); // ordStatus 열의 클래스 추가
			    } else if (row.ordStatus === '계획반영') {
			    	grid.addCellClassName(row.rowKey, 'ordStatus', 'bg-warning');
			    }
			});
			
			grid.on('click', (ev) => {
			    const rowKey = ev.rowKey;
			    const ordCodeValue = grid.getValue(rowKey, 'ordCode');
			    
			    if(ordCodeValue) {
			    	$.ajax({
			    		url : '/getOrderDetail',
			    		type : 'POST',
			    		contentType : 'application/json',
			    		data : JSON.stringify({ordCode : ordCodeValue}),
			    		success: function(response) {
			    			document.getElementById('gridOrderDetail').style.display = 'block';
			    			gridModal.resetData(response);
			    			gridModal.refreshLayout();

			    			// 재고부족인 경우 배경색 변경
			    			const lackOrdCodes = grid.getData()
			    			    .filter(row => row.ordStatus === '재고부족')
			    			    .map(row => row.ordCode);

			    			// 각 lackOrdCode에 대해 rowKey를 찾고 배경색 변경
			    			lackOrdCodes.forEach(lackOrdCode => {
			    			    gridModal.getData().forEach(row => {
			    			        if (row.ORDCODE === lackOrdCode) {
			    			            gridModal.addCellClassName(row.rowKey, 'LACKQUANTITY', 'bg-light-pink');
			    			        }
			    			    });
			    			});

			    			// ordStatus가 '계획반영'인 경우 배경색 변경
			    			const planOrdCodes = grid.getData()
			    			    .filter(row => row.ordStatus === '계획반영')
			    			    .map(row => row.ordCode);

			    			// 각 planOrdCode에 대해 rowKey를 찾고 배경색 변경
			    			planOrdCodes.forEach(planOrdCode => {
			    			    gridModal.getData().forEach(row => {
			    			        if (row.ORDCODE === planOrdCode) {
			    			            gridModal.addCellClassName(row.rowKey, 'LACKQUANTITY', 'bg-warning');
			    			        }
			    			    });
			    			});
			                
			    		},
			    		error: function(xhr, status, error) {
			    			console.error('error during request', error);
			    		}
			    	});
			    }  
			});
			
		});
		
		const radioButtons = document.querySelectorAll('input[name="option"]');
	    radioButtons.forEach(radio => {
	        radio.addEventListener('change', function() {
	            performSearch(); // 여기에서 원하는 함수를 호출
	        });
	    });
		
		function performSearch() {
		    const companyName = document.getElementById('companyName').value;
		    const orderStartDate = document.getElementById('orderStartDate').value;
		    const orderEndDate = document.getElementById('orderEndDate').value;
		    const deliveryStartDate = document.getElementById('deliveryStartDate').value;
		    const deliveryEndDate = document.getElementById('deliveryEndDate').value;
		    
		    const selectedOption = document.querySelector('input[name="option"]:checked');
		    const orderStatus = selectedOption ? selectedOption.value : null; // 선택된 값이 없을 경우 null 처리
		    
		    const searchCriteria = {
		        companyName: companyName,
		        orderStartDate: orderStartDate,
		        orderEndDate: orderEndDate,
		        deliveryStartDate: deliveryStartDate,
		        deliveryEndDate: deliveryEndDate,
		        orderStatus: orderStatus 
		    };

		    $.ajax({
		        url: '/searchOrder',
		        type: 'POST',
		        contentType: 'application/json',
		        data: JSON.stringify(searchCriteria),
		        success: function(response) {
		            grid.resetData(response);
		            grid.getData().forEach(row => {
					    if (row.ordStatus === '재고부족') {
					    	grid.addCellClassName(row.rowKey, 'ordStatus', 'bg-light-pink');
					    } else if(row.ordStatus == '계획반영') {
					    	grid.addCellClassName(row.rowKey, 'ordStatus', 'bg-warning');
					    }
					});
		        },
		        error: function(xhr, status, error) {
		            console.error('Error fetching search results:', error);
		        }
		    });
		}
	</script>
</div>