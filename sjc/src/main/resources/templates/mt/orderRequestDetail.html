<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">

<head>
    <title>발주 상세내역</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>

<body>

<h1>발주 상세내역</h1>

<table class="table table-striped">
    <thead>
        <tr>
            <th>자재 발주 상세 코드</th>
            <th>자재 코드</th>
            <th>자재 명</th>
            <th>규격</th>
            <th>단가</th>
            <th>수량</th>
            <th>주문 금액</th> <!-- 새로운 열 추가 -->
            <th>발주 일자</th>
            <th>비고</th>
        </tr>
    </thead>
   
    <tbody id="orderDetailsBody">
        <tr th:each="detail : ${orderDetails}">
            <td th:text="${detail.mtlOdDetailCode != null ? detail.mtlOdDetailCode : '-'}"></td>
            <td th:text="${detail.mtCode != null ? detail.mtCode : '-'}"></td>
            <td th:text="${detail.mtName != null ? detail.mtName : '-'}"></td>
            <td th:text="${detail.specification != null ? detail.specification : '-'}"></td>
            <td th:text="${detail.unitPrice != null ? detail.unitPrice : '-'}"></td>
            <td th:text="${detail.quantity != null ? detail.quantity : '-'}"></td>
            
            <!-- 주문 금액 계산 -->
            <td th:text="${detail.unitPrice != null && detail.quantity != null ? detail.unitPrice * detail.quantity : '-'}"></td>
            
            <td th:text="${detail.mtlOdDate != null ? #dates.format(detail.mtlOdDate, 'yyyy-MM-dd') : '-'}"></td>
            <td th:text="${detail.comm != null ? detail.comm : '-'}"></td>
        </tr>
    </tbody>
</table>

<a href="/orderRequestList" class="btn btn-primary">발주 목록으로 돌아가기</a>
<script>
function loadOrderDetails(cpCode) {
    $.ajax({
        url: '/orderRequestDetails',
        method: 'GET',
        data: { cpCode: cpCode },
        success: function(data) {
            let detailsTable = $('#order-details-table tbody');
            detailsTable.empty();
            if (data.length > 0) {
                data.forEach(function(detail) {
                    const orderAmount = detail.unitPrice && detail.quantity ? detail.unitPrice * detail.quantity : '-';
                    detailsTable.append(`
                        <tr>
                            <td>${detail.mtlOdDetailCode || '-'}</td>
                            <td>${detail.mtCode || '-'}</td>
                            <td>${detail.mtName || '-'}</td>
                            <td>${detail.specification || '-'}</td>
                            <td>${detail.unitPrice || '-'}</td>
                            <td>${detail.quantity || '-'}</td>
                            <td>${orderAmount}</td> 
                            <td>${detail.mtlOdDate ? new Date(detail.mtlOdDate).toLocaleString() : '-'}</td>
                            <td>${detail.comm || '-'}</td>
                        </tr>
                    `);
                });
            } else {
                detailsTable.append('<tr><td colspan="8">발주 상세 내역이 없습니다.</td></tr>'); // colspan 수정
            }
        },
        error: function() {
            alert('발주 상세 내역을 가져오는 중 오류가 발생했습니다.');
        }
    });
}

</script>
</body>

</html>
