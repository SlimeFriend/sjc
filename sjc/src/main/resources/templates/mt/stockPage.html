<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
	<meta charset="UTF-8">
	<title>전체 재고 관리</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<style>
		.text-danger {
			color: red;
		}
	</style>
</head>
<body>
	<div class="main-container">
		<div class="container">
			<h1>전체 재고 관리</h1>

			<!-- 재고 목록 테이블 -->
			<table class="table table-striped">
				<thead>
					<tr>
						<th>자재 코드</th>
						<th>자재 이름</th>
						<th>자재 구분</th>
						<th>규격</th>
						<th>단위</th>
						<th>단가</th>
						<th>안전재고</th>
						<th>현재재고</th>
						<th>비고</th>
						<th>작업</th>
					</tr>
				</thead>
				<tbody>
					<!-- 재고 목록이 없을 경우 -->
					<tr th:if="${#lists.isEmpty(materials)}">
						<td colspan="10" class="text-center">등록된 재고가 없습니다.</td>
					</tr>
					<!-- 재고 목록이 있을 경우 -->
					<tr th:each="material : ${materials}">
						<td th:text="${material.mtCode}">자재 코드</td>
						<td th:text="${material.mtName}">자재 이름</td>
						<td th:text="${material.materialType}">자재 구분</td>
						<td th:text="${material.specification}">규격</td>
						<td th:text="${material.unit}">단위</td>
						<td th:text="${material.unitPrice}">단가</td>
						<td th:text="${material.safetyStock != null ? material.safetyStock : '-'}">안전재고</td>
						<td th:classappend="${material.currentStc != null and material.currentStc < material.safetyStock} ? 'text-danger' : ''"
							th:text="${material.currentStc != null ? material.currentStc : '-'}">현재재고</td>
						<td th:text="${material.comm != null ? material.comm : '-'}">비고</td>
						<td>
							<!-- 상세확인 버튼 추가 (모달 트리거) -->
							<button type="button" class="btn btn-info" data-toggle="modal"
								data-target="#lotDetailsModal"
								th:attr="onclick='loadLotDetails(' + '\'' + ${material.mtCode} + '\'' + ')'">상세확인</button>
						</td>
					</tr>
				</tbody>
			</table>

			<!-- 자재 구분 입력 및 저장하는 폼 -->
			<h2>자재 구분 입력 및 저장</h2>
			<form th:action="@{/stock/updateMaterialType}" method="post" class="form-inline">
				<div class="form-group mb-2">
					<label for="mtCode" class="sr-only">자재 코드</label>
					<input type="text" class="form-control mr-2" id="mtCode" name="mtCode" placeholder="자재 코드" required>
				</div>
				<div class="form-group mb-2">
					<label for="materialType" class="sr-only">자재 구분</label>
					<input type="text" class="form-control mr-2" id="materialType" name="materialType" placeholder="자재 구분" required>
				</div>
				<button type="submit" class="btn btn-primary mb-2">저장</button>
			</form>

			<!-- 성공 또는 오류 메시지 표시 -->
			<div th:if="${message}" class="alert alert-success mt-3" th:text="${message}"></div>
			<div th:if="${error}" class="alert alert-danger mt-3" th:text="${error}"></div>
		</div>

		<!-- 모달 -->
		<div class="modal fade" id="lotDetailsModal" tabindex="-1" role="dialog" aria-labelledby="lotDetailsModalLabel"
			aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="lotDetailsModalLabel">로트번호별 상세 정보</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body" id="modalBodyContent">
						<!-- AJAX를 통해 로트번호별 정보를 이곳에 불러올 예정 -->
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

	<script>
		function loadLotDetails(mtCode) {
			$.ajax({
				url: '/stock/' + mtCode + '/lots/',
				type: 'GET',
				success: function(response) {
					$('#modalBodyContent').html(response); 
				},
				error: function() {
					alert('로트번호 정보를 불러오는 데 실패했습니다.');
				}
			});
		}
	</script>
</body>
</html>
