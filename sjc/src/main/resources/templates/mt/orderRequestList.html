<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>발주 요청 목록</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
</head>

<body>
    <div class="main-container">
        <div class="container">
            <h1>발주 요청 목록</h1>
            
            <!-- 발주 요청 등록 버튼 -->
            <div class="text-right mb-3">
                <a class="btn btn-primary" th:href="@{/orderRequestNew}">발주 요청 등록</a>
            </div>

            <!-- 발주 요청 목록 그리드 -->
            <div id="orderRequestGrid" style="width: 100%; height: 400px;"></div>

            <h2>발주 상세내역</h2>
            <!-- 발주 상세 내역 그리드 -->
            <div id="orderDetailsGrid" style="width: 100%; height: 300px;"></div>
        </div>
    </div>

    <script th:inline="javascript">
        const orderRequests = /*[[${orderRequests}]]*/ [];

        // 발주 요청 목록 그리드 설정
        const orderRequestGrid = new tui.Grid({
            el: document.getElementById('orderRequestGrid'),
            data: orderRequests,
            columns: [
                { header: '업체 코드', name: 'cpCode', align: 'center' },
                { header: '업체 명', name: 'cpName', align: 'center' },
                { header: '발주 일자', name: 'mtlOdDate', align: 'center', formatter: 'date' },
                { header: '상태', name: 'mtlOdStatus', align: 'center' },
                { header: '총 금액', name: 'totalAmount', align: 'right' },
                { header: '담당자', name: 'userName', align: 'center' },
                {
                    header: '상태변경', 
                    name: 'statusChange', 
                    align: 'center',
                    formatter: 'listItemText',
                    editor: {
                        type: 'select',
                        options: {
                            listItems: [
                                { text: '발주대기', value: '발주대기' },
                                { text: '입고품질검사대기', value: '입고품질검사대기' },
                             
                            ]
                        }
                    }
                },
                {
                    header: '작업', name: 'details', align: 'center',
                    formatter: (item) => {
                        const mtlOdCode = item.row.mtlOdCode;
                        return `<button class="btn btn-info" onclick="showOrderDetails('${mtlOdCode}')">상세보기</button>`;
                    }
                },
                {
                    header: '삭제', name: 'delete', align: 'center',
                    formatter: (item) => {
                        const mtlOdCode = item.row.mtlOdCode;
                        return `<button class="btn btn-danger btn-sm" onclick="deleteOrderRequest('${mtlOdCode}')">삭제</button>`;
                    }
                }
            ]
        });

        // 상태 변경 이벤트 리스너
        orderRequestGrid.on('afterChange', (ev) => {
            if (ev.columnName === 'statusChange') {
                const mtlOdCode = ev.instance.getValue(ev.rowKey, 'mtlOdCode');
                const newStatus = ev.value;

                // 상태 변경 함수 호출
                changeStatus(mtlOdCode, newStatus);
            }
        });

        // 상태 변경 함수
        function changeStatus(mtlOdCode, newStatus) {
            fetch('/orderRequest/updateStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `orderRequestCode=${encodeURIComponent(mtlOdCode)}&status=${encodeURIComponent(newStatus)}`
            })
            .then(response => {
                if (response.ok) {
                    alert('상태가 변경되었습니다.');
                    if (newStatus === '입고품질검사완료') {
                        const rowKey = orderRequestGrid.getRowKey(mtlOdCode);
                        orderRequestGrid.removeRow(rowKey);
                    }
                } else {
                    alert('상태 업데이트 중 오류 발생');
                }
            })
            .catch(error => {
                console.error('Error updating status:', error);
                alert('상태 업데이트 중 문제가 발생했습니다.');
            });
        }

        // 발주 요청 상세보기 함수
        function showOrderDetails(mtlOdCode) {
            fetch(`/orderRequestDetails?mtlOdCode=${encodeURIComponent(mtlOdCode)}`)
                .then(response => response.json())
                .then(data => {
                    orderDetailsGrid.resetData(data.map(detail => ({
                        ...detail,
                        orderAmount: detail.unitPrice && detail.quantity ? detail.unitPrice * detail.quantity : '-'
                    })));
                })
                .catch(error => console.error("Error fetching order details:", error));
        }

        // 발주 요청 삭제 함수
        function deleteOrderRequest(mtlOdCode) {
            if (!confirm('정말로 삭제하시겠습니까?')) return;

            fetch('/orderRequest/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `mtlOdCode=${encodeURIComponent(mtlOdCode)}`
            })
            .then(response => {
                if (response.ok) {
                    alert('발주 요청이 삭제되었습니다.');
                    const rowKey = orderRequestGrid.getRowKey(mtlOdCode);
                    orderRequestGrid.removeRow(rowKey);
                } else {
                    alert('삭제 중 오류 발생');
                }
            })
            .catch(error => console.error('Error deleting order request:', error));
        }

        // 발주 상세 내역 그리드 설정
        const orderDetailsGrid = new tui.Grid({
            el: document.getElementById('orderDetailsGrid'),
            data: [],
            columns: [
                { header: '자재 발주 상세 코드', name: 'mtlOdDetailCode', align: 'center' },
                { header: '자재 코드', name: 'mtCode', align: 'center' },
                { header: '자재 명', name: 'mtName', align: 'center' },
                { header: '규격', name: 'specification', align: 'center' },
                { header: '단가', name: 'unitPrice', align: 'right' },
                { header: '수량', name: 'quantity', align: 'right' },
                { header: '주문 금액', name: 'orderAmount', align: 'right' },
                { header: '발주 일자', name: 'mtlOdDate', align: 'center' },
                { header: '상태', name: 'status', align: 'center' }
            ]
        });
    </script>

</body>
</html>
