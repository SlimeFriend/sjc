<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>발주 요청 목록</title>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
.hidden {
	display: none;
}
</style>
</head>
<body>
	<div class="main-container">
		<div class="container">
			<h1>발주 요청 목록</h1>
			<div class="text-right mb-3">
				<a class="btn btn-primary" th:href="@{/orderRequestNew}">발주 요청
					등록</a>
			</div>

			<!-- 발주 요청 목록 테이블 -->
			<table class="table table-striped">
				<thead>
					<tr>
						<th>업체 코드</th>
						<th>발주 일자</th>
						<th>상태</th>
						<th>총 금액</th>
						<th>담당자</th>
						<th>상태변경</th>
						<th>작업</th>
						<th>삭제</th>

					</tr>
				</thead>
				<tbody>
					<tr th:each="orderRequest, iterStat : ${orderRequests}"
						th:if="${iterStat.first || orderRequest.cpCode != orderRequests[iterStat.index - 1].cpCode}"
						th:attr="data-cpCode=${orderRequest.cpCode}">
						<td th:text="${orderRequest.cpCode}"></td>
						<td
							th:text="${#dates.format(orderRequest.mtlOdDate, 'yyyy-MM-dd')}"></td>
						<td th:text="${orderRequest.mtlOdStatus}"></td>
						  <td th:text="${orderRequest.totalAmount != null ? orderRequest.totalAmount : '-'}"></td> 

						<td th:text="${orderRequest.userId}"></td>
						<td><select class="form-control"
							th:id="|statusSelect_${orderRequest.cpCode}|">
								<option th:selected="${orderRequest.mtlOdStatus == '발주대기'}"
									value="발주대기">발주대기</option>
								<option th:selected="${orderRequest.mtlOdStatus == '품질검사대기'}"
									value="품질검사대기">품질검사대기</option>
						</select>
							<button class="btn btn-secondary"
								th:onclick="updateStatus([[${orderRequest.cpCode}]])">변경하기</button>
						</td>
						<td>
							<button class="btn btn-info"
								th:data-cp-code="${orderRequest.cpCode}"
								th:onclick="showOrderDetails(this.dataset.cpCode)">상세보기</button>
						</td>
						<td>
							<button class="btn btn-danger btn-sm"
								th:onclick="deleteOrderRequest([[${orderRequest.cpCode}]])">삭제</button>
						</td>
					</tr>
				</tbody>
			</table>

			<!-- 발주 요청 상세 테이블 -->
			<h2>발주 상세내역</h2>
			<table class="table table-striped">
				<thead>
					<tr>
						<th>자재 발주 상세 코드</th>
						<th>자재 코드</th>
						<th>자재 명</th>
						<th>규격</th>
						<th>단가</th>
						<th>수량</th>
						<th>주문 금액</th>
						<th>발주 일자</th>
						<th>비고</th>
					</tr>
				</thead>
				<tbody id="orderDetailsBody">
					<tr>
						<td colspan="9">상세 내역을 선택하세요.</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script type="text/javascript">
	function showOrderDetails(cpCode, mtlOdCode) {
	    const encodedCpCode = encodeURIComponent(cpCode);
	    fetch('/orderRequestDetails?cpCode=' + encodedCpCode)
	        .then(response => response.json())
	        .then(data => {
	            let tbody = document.getElementById("orderDetailsBody");
	            tbody.innerHTML = "";  // 기존 내용 초기화

	            let totalOrderAmount = 0; // 주문 금액 총합 초기화

	            if (data.length === 0) {
	                tbody.innerHTML = "<tr><td colspan='9'>상세 내역이 없습니다.</td></tr>";
	            } else {
	                data.forEach(detail => {
	                    const orderAmount = detail.unitPrice && detail.quantity ? detail.unitPrice * detail.quantity : 0;
	                    totalOrderAmount += orderAmount; // 주문 금액 합산
	                    let row = `<tr>
	                                <td>${detail.mtlOdDetailCode || '-'}</td>
	                                <td>${detail.mtCode || '-'}</td>
	                                <td>${detail.mtName || '-'}</td>
	                                <td>${detail.specification || '-'}</td>
	                                <td>${detail.unitPrice || '-'}</td>
	                                <td>${detail.quantity || '-'}</td>
	                                <td>${orderAmount}</td> 
	                                <td>${detail.mtlOdDate ? new Date(detail.mtlOdDate).toLocaleDateString() : '-'}</td>
	                                <td>${detail.comm || '-'}</td>
	                            </tr>`;
	                    tbody.innerHTML += row;
	                });
	            }
	            // 총 금액을 화면에 표시
	            document.getElementById("totalAmountDisplay").innerText = totalOrderAmount;
	        })
	        .catch(error => console.error('Error:', error));
	}


    function updateStatus(mtlOdCode, cpCode) {
        const selectElement = document.getElementById(`statusSelect_${mtlOdCode}`);
        const newStatus = selectElement.value;

        fetch('/orderRequest/updateStatus', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `orderRequestCode=${mtlOdCode}&status=${newStatus}&cpCode=${cpCode}`
        })
        .then(response => {
            if (!response.ok) {
                alert('상태 업데이트 중 오류 발생');
            } else {
                alert('상태가 변경되었습니다.'); // 성공 메시지
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function deleteOrderRequest(cpCode) {
        if (!cpCode) {
            alert('cpCode가 유효하지 않습니다.');
            return;
        }

        if (!confirm('정말로 삭제하시겠습니까?')) {
            return;
        }

        fetch('/orderRequest/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `cpCode=${encodeURIComponent(cpCode)}`
        })
        .then(response => {
            if (!response.ok) {
                alert('삭제 중 오류 발생');
            } else {
                alert('발주 요청이 삭제되었습니다.');
                document.querySelectorAll(`tr[data-cpCode="${cpCode}"]`).forEach(row => row.remove());
            }
        })
        .catch(error => console.error('Error:', error));
    }


</script>
</body>
</html>
