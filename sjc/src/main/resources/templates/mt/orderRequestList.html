<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout" 
      layout:decorate="~{common/layouts/default_layout}" 
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>발주 요청 목록</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="main-container">
    <div class="container">
        <h1>발주 요청 목록</h1>
        <div class="text-right mb-3">
            <a class="btn btn-primary" th:href="@{/orderRequestNew}">발주 요청 등록</a>
        </div>

        <!-- 발주 요청 목록 테이블 -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>업체 코드</th>
                    <th>발주 일자</th>
                    <th>상태</th>
                    <th>총 금액</th>
                    <th>담당자</th>
                    <th>상태변경</th>
                    <th>작업</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="orderRequest : ${orderRequests}" 
                    th:data-mtlodcode="${orderRequest.mtlOdCode}">
                    <td th:text="${orderRequest.cpCode}"></td>
                    <td th:text="${#dates.format(orderRequest.mtlOdDate, 'yyyy-MM-dd')}"></td>
                    <td id="status_${orderRequest.mtlOdCode}" th:text="${orderRequest.mtlOdStatus}"></td>
                    <td th:text="${orderRequest.totalAmount != null ? orderRequest.totalAmount : '-'}"></td>
                    <td th:text="${orderRequest.userName}"></td>
                    <td>
                        <select class="form-control" 
                                th:id="|statusSelect_${orderRequest.mtlOdCode}|">
                            <option th:selected="${orderRequest.mtlOdStatus == '발주대기'}" value="발주대기">발주대기</option>
                            <option th:selected="${orderRequest.mtlOdStatus == '입고품질검사대기'}" value="입고품질검사대기">입고품질검사대기</option>
                        </select>
                        <button class="btn btn-secondary" 
                                th:onclick="updateStatus([[${orderRequest.mtlOdCode}]], [[${orderRequest.cpCode}]])">
                            변경하기
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-info"
                                th:data-mtlodcode="${orderRequest.mtlOdCode}"
                                th:onclick="showOrderDetails(this.dataset.mtlodcode)">
                            상세보기
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm"
                                th:data-mtlodcode="${orderRequest.mtlOdCode}"
                                th:onclick="deleteOrderRequest(this.dataset.mtlodcode)">
                            삭제
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <h2>발주 상세내역</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>자재 발주 상세 코드</th>
                    <th>자재 코드</th>
                    <th>자재 명</th>
                    <th>규격</th>
                    <th>단가</th>
                    <th>수량</th>
                    <th>주문 금액</th>
                    <th>발주 일자</th>
                    <th>비고</th>
                </tr>
            </thead>
            <tbody id="orderDetailsBody">
                <tr>
                    <td colspan="9">상세 내역을 선택하세요.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script type="text/javascript">
function showOrderDetails(mtlOdCode) {
    fetch(`/orderRequestDetails?mtlOdCode=${encodeURIComponent(mtlOdCode)}`)
        .then(response => response.json())
        .then(data => {
            let tbody = document.getElementById("orderDetailsBody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='9'>상세 내역이 없습니다.</td></tr>";
            } else {
                data.forEach(detail => {
                    tbody.innerHTML += `<tr>
                        <td>${detail.mtlOdDetailCode || '-'}</td>
                        <td>${detail.mtCode || '-'}</td>
                        <td>${detail.mtName || '-'}</td>
                        <td>${detail.specification || '-'}</td>
                        <td>${detail.unitPrice != null ? detail.unitPrice : '-'}</td>
                        <td>${detail.quantity != null ? detail.quantity : '-'}</td>
                        <td>${detail.unitPrice && detail.quantity ? (detail.unitPrice * detail.quantity) : '-'}</td>
                        <td>${detail.mtlOdDate ? new Date(detail.mtlOdDate).toLocaleDateString() : '-'}</td>
                        <td>${detail.comm || '-'}</td>
                    </tr>`;
                });
            }
        })
        .catch(error => console.error("Error fetching order details:", error));
}


function updateStatus(mtlOdCode, cpCode) {
    const selectElement = document.getElementById(`statusSelect_${mtlOdCode}`);
    const newStatus = selectElement.value;

    fetch('/orderRequest/updateStatus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `orderRequestCode=${mtlOdCode}&status=${newStatus}&cpCode=${cpCode}`
    })
    .then(response => {
        if (!response.ok) {
            alert('상태 업데이트 중 오류 발생');
        } else {
            alert('상태가 변경되었습니다.');
            document.getElementById(`status_${mtlOdCode}`).textContent = newStatus;
        }
    })
    .catch(error => console.error('Error updating status:', error));
}

function deleteOrderRequest(mtlOdCode) {
    if (!confirm('정말로 삭제하시겠습니까?')) return;

    fetch('/orderRequest/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `mtlOdCode=${encodeURIComponent(mtlOdCode)}`
    })
    .then(response => {
        if (!response.ok) {
            alert('삭제 중 오류 발생');
        } else {
            alert('발주 요청이 삭제되었습니다.');
            document.querySelector(`tr[data-mtlodcode="${mtlOdCode}"]`).remove();
          
            document.getElementById("orderDetailsBody").innerHTML = "<tr><td colspan='9'>상세 내역을 선택하세요.</td></tr>";
        }
    })
    .catch(error => console.error('Error deleting order request:', error));
}

</script>
</body>
</html>
