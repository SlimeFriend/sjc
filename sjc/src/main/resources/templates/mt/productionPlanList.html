<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

<head>
<meta charset="UTF-8">
<title>생산 계획 목록</title>
<!-- 페이징필요한사람 -->
	<th:block th:replace="~{common/configs/default_pageing :: pageing}"></th:block>

<style>
.low-stock {
	color: red;
	font-weight: bold;
}

/* tui-grid 선택 테두리 제거 */
.tui-grid-layer-focus-border {
    display: none !important;
}
</style>
</head>
<body>
	<div class="main-container">
		<div class="container">
			<h1>생산 계획 목록</h1>

			<!-- 생산 계획 목록 Grid -->
			<div id="productionPlanGrid" style="width: 100%; height: 300px;"></div>

			<h2 class="mt-4">자재 목록</h2>
			<!-- 자재 목록 Grid -->
			<div id="materialsGrid" style="width: 100%; height: 300px;"></div>
		</div>
	</div>

	<script th:inline="javascript">
        // 타임리프 데이터를 JSON으로 변환
        const productionPlans = /*[[${productionPlans}]]*/ [];
        const materials = /*[[${materials}]]*/ [];

        // 데이터를 반복하여 제품명과 수량을 개별 행으로 표현
        const expandedData = productionPlans.flatMap(plan => 
            plan.planDetails.map(detail => ({
                planCode: plan.planCode,
                productName: detail.prdName,
                quantity: detail.quantity,
                startDate: plan.startDate,
                endDate: plan.endDate,
                prdCode: detail.prdCode
            }))
        );

        // Toast UI Grid 설정 및 데이터 로드
        const productionPlanGrid = new tui.Grid({
            el: document.getElementById('productionPlanGrid'),
            data: expandedData,
            columns: [
                { header: '생산계획코드', name: 'planCode', align: 'center' },
                { header: '제품명', name: 'productName', align: 'center' },
                { header: '수량', name: 'quantity', align: 'right' },
                { header: '시작일자', name: 'startDate', align: 'center' },
                { header: '종료일자', name: 'endDate', align: 'center' }
            ],
            pageOptions: {
                useClient: true,
                perPage: 5
            }
        });

        const materialsGrid = new tui.Grid({
            el: document.getElementById('materialsGrid'),
            data: [],
            columns: [
                { header: '업체코드', name: 'cpCode', align: 'center' },
                { header: '자재명', name: 'mtName', align: 'center' },
                { header: '요청수량', name: 'quantity', align: 'right' },
                { header: '현재재고', name: 'currentStc', align: 'right' },
                { header: '안전재고', name: 'safetyStock', align: 'right' },
                { header: '총소요량', name: 'totalRequired', align: 'right' },
                { 
                    header: '부족수량', 
                    name: 'shortage', 
                    align: 'right',
                    formatter: (item) => {
                        const shortage = item.row.currentStc - item.row.totalRequired;
                        return `<span class="${shortage < 0 ? 'low-stock' : ''}">${shortage} ${shortage < 0 ? '(부족)' : '(충분)'}</span>`;
                    }
                },
                {
                    header: '발주넣기',
                    name: 'order',
                    align: 'center',
                    formatter: (item) => {
                        const cpCode = item.row.cpCode; // 업체 코드
                        if (cpCode) {
                            return `<button class="btn btn-primary btn-sm" data-cpcode="${cpCode}">발주 넣기</button>`;
                        } else {
                            return `<button class="btn btn-primary btn-sm" disabled>발주 넣기</button>`;
                        }
                    }}
            ],
            pageOptions: {
                useClient: true,
                perPage: 5
            }
        });
        
     // 발주 넣기 버튼 클릭 시 호출되는 함수
        window.createOrderRequest = function(cpCode) {
            window.location.href = `/orderRequestNew?cpCode=${encodeURIComponent(cpCode)}`;
        };

        // 클릭 이벤트 리스너 추가
        document.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('btn-primary')) {
                const cpCode = event.target.getAttribute('data-cpcode');
                createOrderRequest(cpCode);
            }
        });

        // 행 클릭 이벤트 처리 - 클릭한 행의 planCode에 따라 자재 목록 업데이트
        productionPlanGrid.on('click', (ev) => {
            const rowKey = ev.rowKey;
            const rowData = productionPlanGrid.getRow(rowKey);

            if (rowData && rowData.planCode) {
                const planCode = rowData.planCode;

                // 기존 자재 목록 초기화
                materialsGrid.resetData([]);

                // 새로운 자재 목록 가져오기
                fetch(`/getMaterialsByPlan?planCode=${encodeURIComponent(planCode)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Fetched materials for planCode:", planCode, data);  // 선택된 planCode와 데이터 확인
                        // 자재 목록 업데이트
                        materialsGrid.resetData(data.map(material => ({
                            ...material,
                            shortage: material.currentStc - material.totalRequired
                        })));
                    })
                    .catch(error => {
                        console.error('Error fetching materials:', error);
                        alert(`Error fetching materials: ${error.message}`);
                    });
            }
        });
    </script>
</body>
</html>
