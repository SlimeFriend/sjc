<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>발주 요청 등록</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
<style>
/* tui-grid 선택 테두리 제거 */
.tui-grid-layer-focus-border {
	display: none !important;
}

#grid:hover {
	cursor: pointer;
}
</style>
</head>

<body>
	<div class="main-container">
		<div class="container">
			<h1>발주 요청 등록</h1>

			<!-- 업체 선택 -->
			<div class="form-group">
				<label for="cpCode">업체 선택</label> <select name="cpCode"
					class="form-control" onchange="loadItemsForCpCode(this.value)">
					<option value="">업체를 선택하세요</option>
					<option th:each="cp : ${cpInfoList}" th:if="${cp.cpType == '자재'}"
						th:value="${cp.cpCode}" th:text="${cp.cpCode + ' / ' + cp.cpName}"
						th:selected="${selectedCpCode == cp.cpCode}"></option>
				</select>
			</div>

			<th:block sec:authorize="isAuthenticated()">
				<label>담당자</label>
				<input class="form-control" type="text" id="userName"
					th:value="${#authentication.principal.authorities[2]}" readonly>
				<input type="hidden"
					th:value="${#authentication.principal.authorities[1]}"
					name="userId" id="userId">
			</th:block>


			<!-- 발주 품목 선택 그리드 -->
			<div id="itemGrid" style="width: 100%; height: 300px;"></div>
			<button type="button" class="btn btn-primary mt-3"
				onclick="submitOrderRequest()">발주 요청 제출</button>
		</div>
	</div>

	<script>
        const itemGrid = new tui.Grid({
            el: document.getElementById('itemGrid'),
            data: [],
            columns: [
                { header: '품목명', name: 'mtName', align: 'center' },
                { header: '규격', name: 'specification', align: 'center' },
                { header: '단가', name: 'unitPrice', align: 'right' },
                {
                    header: '발주 수량 입력',
                    name: 'quantity',
                    editor: 'text',
                    align: 'right'
                }
            ]
        });
        

        // cpCode가 전달되었을 경우 자동으로 아이템 로딩
        document.addEventListener("DOMContentLoaded", function() {
            const selectedCpCode = document.querySelector("select[name='cpCode']").value;
            if (selectedCpCode) {
                loadItemsForCpCode(selectedCpCode);
            }
        });

        function loadItemsForCpCode(cpCode) {
            if (!cpCode) {
                itemGrid.resetData([]);
                return;
            }
            fetch(`/getItemsForCpCode?cpCode=${encodeURIComponent(cpCode)}`)
                .then(response => response.json())
                .then(data => {
                    // 각 품목에 quantity 속성을 0으로 초기화
                    const itemsWithQuantity = data.map(item => ({
                        ...item,
                        quantity: 0
                    }));
                    itemGrid.resetData(itemsWithQuantity);
                })
                .catch(error => console.error("Error fetching items:", error));
        }

        function submitOrderRequest() {
            const cpCode = document.querySelector("select[name='cpCode']").value;
            const userId = document.getElementById("userId").value;  // 문자열 그대로 가져옴
            const items = itemGrid.getData().filter(item => item.quantity > 0);

            console.log("cpCode:", cpCode);
            console.log("userId:", userId);
            console.log("items:", items);

            if (!cpCode) {
                alert("업체를 선택하세요.");
                return;
            }
            
            if (!userId) {
                alert("담당자 ID가 올바르지 않습니다.");
                return;
            }

            if (items.length === 0) {
                alert("발주 수량을 입력하세요.");
                return;
            }

            fetch('/orderRequest/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cpCode, userId, items })
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "/orderRequestList";
                } else {
                    alert("발주 요청 등록에 실패했습니다.");
                }
            })
            .catch(error => console.error("Error submitting order request:", error));
        }


    </script>
</body>
</html>
