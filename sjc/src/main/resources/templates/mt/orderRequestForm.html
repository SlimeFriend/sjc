<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>발주 요청 등록</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="container">
            <h1>발주 요청 등록</h1>

            <!-- 업체 선택 -->
            <div class="form-group">
                <label for="cpCode">업체 선택</label>
                <select name="cpCode" class="form-control" onchange="loadItemsForCpCode(this.value)">
                    <option value="">업체를 선택하세요</option>
                    <option th:each="cp : ${cpInfoList}" th:value="${cp.cpCode}" th:text="${cp.cpCode}">업체명</option>
                </select>
            </div>

            <!-- 품목 목록 (업체 선택 시 동적으로 로딩) -->
            <h2>발주 품목 선택</h2>
            <form th:action="@{/orderRequestForm}" method="post">
                <input type="hidden" name="cpCode" id="selectedCpCode">

                <!-- userId 입력 필드 -->
                <div class="form-group">
                    <label for="userId">담당자 ID</label>
                    <input type="text" name="userId" id="userId" class="form-control" placeholder="담당자 ID를 입력하세요" required>
                </div>

                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>품목명</th>
                            <th>규격</th>
                            <th>단가</th>
                            <th>발주 수량 입력</th>
                        </tr>
                    </thead>
                    <tbody id="itemList"></tbody>
                </table>

                <button type="button" class="btn btn-primary" onclick="submitOrderRequest()">발주 요청 제출</button>
            </form>
        </div>
    </div>

    <script>
    function submitOrderRequest() {
        const cpCode = document.getElementById("selectedCpCode").value;
        const userId = document.getElementById("userId").value;
        const items = [];

        document.querySelectorAll("#itemList input").forEach(input => {
            if (input.value) {
                const mtCode = input.name.split("_")[1];
                items.push({ mtCode: mtCode, quantity: parseInt(input.value) });
            }
        });

        if (!cpCode || !userId || items.length === 0) {
            alert("모든 필드를 채워주세요.");
            return;
        }

        fetch('/orderRequest/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cpCode, userId, items })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("서버에 요청을 보내는 중 오류가 발생했습니다.");
            }
            window.location.href = "/orderRequestList";
        })
        .catch(error => {
            console.error("Error submitting order request:", error);
            alert("발주 요청 등록에 실패했습니다.");
        });
    }

    function loadItemsForCpCode(cpCode) {
        document.getElementById("selectedCpCode").value = cpCode;

        // 업체 선택이 없을 때는 초기 메시지 설정
        if (!cpCode) {
            document.getElementById("itemList").innerHTML = "<tr><td colspan='4'>업체를 선택하세요.</td></tr>";
            return;
        }

        // AJAX 요청을 통해 자재 목록을 가져옴
        fetch('/getItemsForCpCode?cpCode=' + encodeURIComponent(cpCode))
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch items for cpCode: " + cpCode);
                }
                return response.json();
            })
            .then(data => {
                let itemList = document.getElementById("itemList");
                itemList.innerHTML = ''; // 기존 데이터 초기화

                if (data.length === 0) {
                    itemList.innerHTML = "<tr><td colspan='4'>발주 가능한 자재 정보가 없습니다.</td></tr>";
                } else {
                    data.forEach(item => {
                        let row = `<tr>
                            <td>${item.mtName || '-'}</td>
                            <td>${item.specification || '-'}</td>
                            <td>${item.unitPrice || '-'}</td>
                            <td><input type="number" name="quantity_${item.mtCode}" class="form-control" placeholder="수량 입력"></td>
                        </tr>`;
                        itemList.innerHTML += row;
                    });
                }
            })
            .catch(error => console.error("Error fetching items for cpCode:", error));
    }
    </script>
</body>
</html>
