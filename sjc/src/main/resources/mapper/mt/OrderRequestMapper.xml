<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sjc.app.mt.mapper.OrderRequestMapper">

    <!-- 모든 발주 요청 목록 조회 -->
    <select id="getAllOrderRequests" resultType="com.sjc.app.mt.service.OrderRequestVO">
        SELECT
            MTL_OD.MTL_OD_CODE AS orderRequestCode,  
            MTL_OD.MTL_OD_DATE AS orderDate,
            MTL_OD.MT_CODE AS mtCode,
            MT.MT_NAME AS mtName,
            MTL_OD.MTL_OD_QUANTITY AS quantity,
            MTL_OD.CP_CODE AS cpCode,
            MTL_OD.USER_ID AS userId,
            MTL_OD.MTL_OD_STATUS AS status,
            MTL_OD.COMM AS comm,
            MTL_OD.PRICE AS price
        FROM
            MTL_OD  
        LEFT JOIN
            MT ON MTL_OD.MT_CODE = MT.MT_CODE  
        ORDER BY
            MTL_OD.MTL_OD_CODE
    </select>

    <!-- 특정 발주 요청 조회 -->
    <select id="getOrderRequestById" parameterType="String" resultType="com.sjc.app.mt.service.OrderRequestVO">
        SELECT
            MTL_OD.MTL_OD_CODE AS orderRequestCode,  
            MTL_OD.MTL_OD_DATE AS orderDate,
            MTL_OD.MT_CODE AS mtCode,
            MT.MT_NAME AS mtName,
            MTL_OD.MTL_OD_QUANTITY AS quantity,
            MTL_OD.CP_CODE AS cpCode,
            MTL_OD.USER_ID AS userId,
            MTL_OD.MTL_OD_STATUS AS status,
            MTL_OD.PRICE AS price
        FROM
            MTL_OD 
        LEFT JOIN
            MT ON MTL_OD.MT_CODE = MT.MT_CODE 
        WHERE
            MTL_OD.MTL_OD_CODE = #{orderId}  
    </select>

    <!-- 발주 요청 등록 -->
    <insert id="insertOrderRequest" parameterType="OrderRequestVO">
        INSERT INTO MTL_OD  
        (MTL_OD_CODE, MTL_OD_DATE, MT_CODE, MTL_OD_QUANTITY, CP_CODE, USER_ID, COMM, DILIVERY_DATE, PRICE)
        VALUES
        (
            'MTL' || TO_CHAR(SYSDATE, 'YYMMDD') || LPAD(MTL_OD_SEQ.NEXTVAL, 3, '0'),
            SYSDATE,
            #{mtCode},
            #{quantity},
            #{cpCode},
            #{userId},
            #{comm},
            SYSDATE + 7,
            (SELECT UNIT_PRICE FROM MT WHERE MT.MT_CODE = #{mtCode}) * #{quantity}
        )
    </insert>

    <!-- 발주 요청 수정 (PRICE 자동 계산 추가) -->
    <update id="updateOrderRequest" parameterType="com.sjc.app.mt.service.OrderRequestVO">
        UPDATE MTL_OD  
        <set>
            <if test="mtCode != null">MT_CODE = #{mtCode},</if>
            <if test="quantity != null">MTL_OD_QUANTITY = #{quantity},</if>
            <if test="cpCode != null">CP_CODE = #{cpCode},</if>
            <if test="userId != null">USER_ID = #{userId},</if>
            <!-- 자재 단가와 수량에 따른 PRICE 자동 계산 -->
            <if test="mtCode != null and quantity != null">
                PRICE = (SELECT UNIT_PRICE FROM MT WHERE MT.MT_CODE = #{mtCode}) * #{quantity},
            </if>
        </set>
        WHERE
            MTL_OD_CODE = #{orderRequestCode}  
    </update>

    <!-- 발주 요청 삭제 -->
    <delete id="deleteOrderRequest" parameterType="String">
        DELETE FROM MTL_OD WHERE MTL_OD_CODE = #{orderRequestCode} 
    </delete>

    <!-- 자재 상태 업데이트 -->
    <update id="updateOrderRequestStatus">
        UPDATE MTL_OD 
        SET MTL_OD_STATUS = #{status}
        WHERE MTL_OD_CODE = #{orderRequestCode}  
    </update>

</mapper>
