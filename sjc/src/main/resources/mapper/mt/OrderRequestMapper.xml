<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sjc.app.mt.mapper.OrderRequestMapper">

    <!-- 업체별 발주 요청 목록 조회 (MtlOdVO 사용) -->
    <select id="getAllOrderRequestsByCpCode" parameterType="String" resultType="com.sjc.app.mt.service.MtlOdVO">
        SELECT
            MTL_OD.MTL_OD_CODE AS orderRequestCode,
            MTL_OD.MTL_OD_DATE AS orderDate,
            MTL_OD.USER_ID AS userId,
            MTL_OD.MTL_OD_STATUS AS status,
            MTL_OD.CP_CODE AS cpCode,
            CP.CP_NAME AS cpName
        FROM
            MTL_OD
        LEFT JOIN
            CP ON MTL_OD.CP_CODE = CP.CP_CODE
        WHERE
            MTL_OD.CP_CODE = #{cpCode}
        ORDER BY
            MTL_OD.MTL_OD_CODE
    </select>

    <!-- CP_CODE로 업체 정보 조회 -->
    <select id="getCpInfoByCpCode" parameterType="String" resultType="com.sjc.app.sales.service.CpVO">
        SELECT
            CP_CODE AS cpCode,
            CP_NAME AS cpName,
            BUSINESS_NO AS businessNo,
            ADDRESS AS address,
            COMM AS comm,
            CP_TYPE AS cpType
        FROM
            CP
        WHERE
            CP_CODE = #{cpCode}
    </select>

    <!-- 모든 업체 정보 조회 -->
    <select id="getAllCpInfo" resultType="com.sjc.app.sales.service.CpVO">
        SELECT
            CP_CODE AS cpCode,
            CP_NAME AS cpName,
            BUSINESS_NO AS businessNo,
            ADDRESS AS address,
            COMM AS comm,
            CP_TYPE AS cpType
        FROM
            CP
    </select>

    <!-- 업체 코드에 속한 자재들의 상태를 '품질검사대기'로 일괄 변경 -->
    <update id="updateOrderRequestStatusByCpCode" parameterType="String">
        UPDATE MTL_OD
        SET MTL_OD_STATUS = '품질검사대기'
        WHERE CP_CODE = #{cpCode}
    </update>

    <!-- 업체별 발주 상세 내역 조회 -->
    <select id="getOrderRequestDetailsByCpCode" parameterType="String" resultType="com.sjc.app.mt.service.MtVO">
        SELECT
            MTL_OD_DETAIL.MTL_OD_DETAIL_CODE AS orderRequestDetailCode,
            MTL_OD_DETAIL.MT_CODE AS mtCode,
            MT.MT_NAME AS mtName,
            MTL_OD_DETAIL.QUANTITY AS quantity
        FROM
            MTL_OD_DETAIL
        LEFT JOIN
            MT ON MTL_OD_DETAIL.MT_CODE = MT.MT_CODE
        LEFT JOIN
            MTL_OD ON MTL_OD.MTL_OD_CODE = MTL_OD_DETAIL.MTL_OD_CODE
        WHERE
            MTL_OD.CP_CODE = #{cpCode}
    </select>

    <!-- 특정 발주 요청에 대한 상세 정보 조회 -->
    <select id="getOrderRequestDetailsByOrderRequestCode" parameterType="String" resultType="com.sjc.app.mt.service.MtVO">
        SELECT
            MTL_OD_DETAIL.MTL_OD_DETAIL_CODE AS orderRequestDetailCode,
            MTL_OD_DETAIL.MT_CODE AS mtCode,
            MT.MT_NAME AS mtName,
            MTL_OD_DETAIL.QUANTITY AS quantity
        FROM
            MTL_OD_DETAIL
        LEFT JOIN
            MT ON MTL_OD_DETAIL.MT_CODE = MT.MT_CODE
        WHERE
            MTL_OD_DETAIL.MTL_OD_CODE = #{orderRequestCode}
    </select>

    <!-- 업체별 발주 상태 업데이트 -->
    <update id="updateOrderRequestStatusForCpCode" parameterType="map">
        UPDATE MTL_OD
        SET MTL_OD_STATUS = #{status}
        WHERE CP_CODE = #{cpCode}
    </update>

</mapper>
