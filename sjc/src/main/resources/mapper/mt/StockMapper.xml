<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sjc.app.mt.mapper.StockMapper">

    <!-- 전체 자재 목록 조회 -->
    <select id="getAllMaterials" resultType="com.sjc.app.mt.service.MtVO">
        SELECT
            MT_CODE AS mtCode,
            MT_NAME AS mtName,
            MATERIAL_TYPE AS materialType,
            SPECIFICATION AS specification,
            UNIT AS unit,
            UNIT_PRICE AS unitPrice,
            SAFETY_STOCK AS safetyStock,
            COMM AS comm,
            STC_CODE AS stcCode,
            CURRENT_STC AS currentStc
        FROM MT
    </select>

    <!-- 자재 코드로 자재 정보 조회 -->
    <select id="getMaterialByCode" parameterType="String" resultType="com.sjc.app.mt.service.MtVO">
        SELECT
            MT_CODE AS mtCode,
            MT_NAME AS mtName,
            SAFETY_STOCK AS safetyStock,
            CURRENT_STC AS currentStc
        FROM MT
        WHERE MT_CODE = #{mtCode}
    </select>

    <!-- 입고 품질검사완료 상태 자재 목록 조회 -->
    <select id="getCompletedInspectionMaterials" resultType="com.sjc.app.mt.service.MtVO">
        SELECT 
            MT.MT_CODE AS mtCode,
            MT.MT_NAME AS mtName,
            MT_IN.INQUANTITY AS quantity,
            MT.CURRENT_STC AS currentStc
        FROM MT_IN
        JOIN MT ON MT_IN.MT_CODE = MT.MT_CODE
        JOIN MTL_OD ON MT_IN.MTL_OD_CODE = MTL_OD.MTL_OD_CODE  -- MTL_OD 테이블과 조인
        WHERE MTL_OD.MTL_OD_STATUS = '입고품질검사완료'
    </select>

    <!-- 현재 재고 업데이트 -->
    <update id="updateCurrentStock">
        UPDATE MT
        SET CURRENT_STC = CURRENT_STC + #{quantity}
        WHERE MT_CODE = #{mtCode}
    </update>

    <!-- 자재 구분 업데이트 -->
    <update id="updateMaterialType">
        UPDATE MT
        SET MATERIAL_TYPE = #{materialType}
        WHERE MT_CODE = #{mtCode}
    </update>

    <!-- 로트번호별 자재 수량 조회 -->
    <select id="getMaterialsByLotNo" parameterType="String" resultType="com.sjc.app.mt.service.MtInVO">
        SELECT 
            LOT_NO AS lotNo,
            INQUANTITY AS inQuantity
        FROM MT_IN
        WHERE MT_CODE = #{mtCode}
    </select>

    <!-- 로트번호별 자재 수량 합계 조회 (현재 재고로 반영) -->
    <select id="getTotalQuantityByLotNo" parameterType="String" resultType="Integer">
        SELECT 
            SUM(INQUANTITY)
        FROM MT_IN
        WHERE MT_CODE = #{mtCode}
    </select>

</mapper>
